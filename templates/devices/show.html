{% extends "base.html" %}

{% block title %}Device Details - Pycube MDM{% endblock %}

{% block extra_head %}
<style>
    .eol-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.9em;
    }
    .eol-active { background-color: #d1fae5; color: #065f46; }
    .eol-warning { background-color: #fef3c7; color: #92400e; }
    .eol-critical { background-color: #fee2e2; color: #991b1b; }
    .eol-expired { background-color: #fee2e2; color: #991b1b; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
            <div>
                <h1>Device Details</h1>
                <p class="text-muted mb-0">{{ device.manufacturer }} {{ device.model }}</p>
            </div>
            <div style="display: flex; gap: var(--spacing-sm);">
                <a href="{{ url_for('devices.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Devices
                </a>
                <a href="{{ url_for('devices.edit', device_id=device.id) }}" class="btn btn-warning">Edit Device</a>
                <button class="btn btn-danger delete-device" data-id="{{ device.id }}">Delete Device</button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-6">
                <div style="display: flex; align-items: center; margin-bottom: var(--spacing-md);">
                    <div class="status-indicator status-{{ device.status.lower() }}" style="width: 16px; height: 16px;"></div>
                    <span style="font-size: var(--font-size-large); font-weight: 600; margin-left: var(--spacing-sm);">
                        {{ device.status }}
                    </span>
                </div>
                
                <h3>{{ device.manufacturer }} {{ device.model }}</h3>
                
                <table style="width: 100%; margin-top: var(--spacing-md);">
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Serial Number:</td>
                        <td>{{ device.serial_number }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">EPC Code:</td>
                        <td>{{ device.rfid_tag }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Barcode:</td>
                        <td>{{ device.barcode }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Hospital:</td>
                        <td>
                            {% if device.hospital_id %}
                                <a href="{{ url_for('hospitals.show', hospital_id=device.hospital_id) }}">
                                    {{ device.hospital_name }}
                                </a>
                            {% else %}
                                Not assigned
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Location:</td>
                        <td>{{ device.location_name if device.location_name else 'Not assigned' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Assigned To:</td>
                        <td>{{ device.assigned_to or 'Unassigned' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Purchase Date:</td>
                        <td>{{ device.purchase_date.strftime('%m/%d/%Y') if device.purchase_date else 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Last Maintenance:</td>
                        <td>{{ device.last_maintenance_date.strftime('%m/%d/%Y') if device.last_maintenance_date else 'No maintenance records' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: var(--spacing-xs) 0; font-weight: 500;">Added On:</td>
                        <td>{{ device.created_at.strftime('%m/%d/%Y %I:%M %p') if device.created_at else 'Unknown' }}</td>
                    </tr>
                </table>

                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background-color: var(--primary-50); border-radius: var(--border-radius-md);">
                    <h4 style="margin-bottom: var(--spacing-md);">End of Life Information</h4>
                    <table style="width: 100%;">
                        <tr>
                            <td style="padding: var(--spacing-xs) 0; font-weight: 500;">EOL Date:</td>
                            <td>{{ device.eol_date.strftime('%m/%d/%Y') if device.eol_date else 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td style="padding: var(--spacing-xs) 0; font-weight: 500;">EOL Status:</td>
                            <td>
                                {% if device.eol_status %}
                                <span class="eol-status eol-{{ device.eol_status.lower() }}">{{ device.eol_status }}</span>
                                {% else %}
                                Not set
                                {% endif %}
                            </td>
                        </tr>
                        {% if device.eol_notes %}
                        <tr>
                            <td style="padding: var(--spacing-xs) 0; font-weight: 500;">EOL Notes:</td>
                            <td>{{ device.eol_notes }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
            
            <div class="col-6">
                <div class="card" style="background-color: var(--primary-50); padding: var(--spacing-md);">
                    <h3>Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                        <button id="scanBtn" class="btn btn-success">Re-scan RFID Tag</button>
                        
                        {% if device.status == 'Missing' %}
                        <button id="markFoundBtn" class="btn btn-primary">Mark as Found</button>
                        {% elif device.status == 'Available' %}
                        <button id="markInUseBtn" class="btn btn-info">Mark as In-Use</button>
                        {% elif device.status == 'In-Use' %}
                        <button id="markAvailableBtn" class="btn btn-success">Mark as Available</button>
                        <button id="markMaintenanceBtn" class="btn btn-warning">Mark for Maintenance</button>
                        {% elif device.status == 'Maintenance' %}
                        <button id="markAvailableBtn" class="btn btn-success">Mark as Available</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <hr style="margin: var(--spacing-lg) 0;">
        
        <h2>Assignment History</h2>
        {% if assignments %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Assigned To</th>
                    <th>Department</th>
                    <th>Assigned At</th>
                    <th>Status</th>
                    <th>Returned At</th>
                </tr>
            </thead>
            <tbody>
                {% for assignment in assignments %}
                <tr>
                    <td>{{ assignment.nurse_name }}</td>
                    <td>{{ assignment.department }}</td>
                    <td>{{ assignment.created_at.strftime('%m/%d/%Y %I:%M %p') if assignment.created_at else 'Unknown' }}</td>
                    <td>{{ assignment.status }}</td>
                    <td>{{ assignment.returned_at.strftime('%m/%d/%Y %I:%M %p') if assignment.returned_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No assignment history found for this device.</p>
        {% endif %}
        
        <hr style="margin: var(--spacing-lg) 0;">
        
        <h2>Reader Events</h2>
        
        {% if movements %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Location</th>
                    <th>Reader ID</th>
                </tr>
            </thead>
            <tbody>
                {% for movement in movements %}
                <tr>
                    <td>{{ movement.timestamp.strftime('%m/%d/%Y %I:%M %p') if movement.timestamp else 'Unknown' }}</td>
                    <td>{{ movement.location_name or 'Unknown' }}</td>
                    <td>{{ movement.reader_id or 'Unknown' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No reader events found for this device.</p>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; top: 50%; transform: translateY(-50%); margin: 0 auto; width: 400px; background-color: white; padding: var(--spacing-lg); border-radius: var(--border-radius-md); box-shadow: var(--shadow-lg);">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this device? This action cannot be undone.</p>
        <div style="display: flex; justify-content: flex-end; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
            <button id="cancelDelete" class="btn btn-info">Cancel</button>
            <form id="deleteForm" method="POST" action="{{ url_for('devices.delete', device_id=device.id) }}">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Delete modal functionality
        const deleteModal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');
        const cancelDelete = document.getElementById('cancelDelete');
        
        document.querySelector('.delete-device').addEventListener('click', function() {
            deleteModal.style.display = 'block';
        });
        
        cancelDelete.addEventListener('click', function() {
            deleteModal.style.display = 'none';
        });
        
        deleteModal.addEventListener('click', function(event) {
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
        
        // Scan button
        document.getElementById('scanBtn').addEventListener('click', function() {
            // Simulate RFID scan - in a real app, this would connect to an RFID reader
            const rfidTag = prompt('Enter RFID tag to scan:');
            
            if (rfidTag) {
                alert(`RFID Tag scanned: ${rfidTag}`);
                // In a real app, this would update the device's RFID tag
            }
        });
        
        // Status change buttons
        {% if device.status == 'Missing' %}
        document.getElementById('markFoundBtn').addEventListener('click', function() {
            if (confirm('Mark this device as found and available?')) {
                updateDeviceStatus('Available');
            }
        });
        {% elif device.status == 'Available' %}
        document.getElementById('markInUseBtn').addEventListener('click', function() {
            if (confirm('Mark this device as in use?')) {
                updateDeviceStatus('In-Use');
            }
        });
        {% elif device.status == 'In-Use' %}
        document.getElementById('markAvailableBtn').addEventListener('click', function() {
            if (confirm('Mark this device as available?')) {
                updateDeviceStatus('Available');
            }
        });
        document.getElementById('markMaintenanceBtn').addEventListener('click', function() {
            if (confirm('Mark this device for maintenance?')) {
                updateDeviceStatus('Maintenance');
            }
        });
        {% elif device.status == 'Maintenance' %}
        document.getElementById('markAvailableBtn').addEventListener('click', function() {
            if (confirm('Mark this device as available?')) {
                updateDeviceStatus('Available');
            }
        });
        {% endif %}
        
        function updateDeviceStatus(status) {
            const url = "{{ url_for('devices.update_status', device_id=device.id) }}";
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Error updating device status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating device status');
            });
        }
    });
</script>
{% endblock %} 